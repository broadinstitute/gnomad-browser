services:
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_USER: gnomad
      POSTGRES_PASSWORD: gnomad_dev
      POSTGRES_DB: gnomad_copilot
    ports:
      - 5432:5432
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U gnomad -d gnomad_copilot"]
      interval: 5s
      timeout: 5s
      retries: 5
  elasticsearch-proxy:
    image: gcr.io/google.com/cloudsdktool/cloud-sdk
    command:
      - sh
      - -c
      - gcloud container clusters get-credentials gnomad-v4 --project=$$PROJECT --zone=$$ZONE && kubectl port-forward --address=$$(awk 'END { print $$1 }' /etc/hosts) service/gnomad-es-http 9200
    environment:
      - PROJECT
      - ZONE
      - CLOUDSDK_CORE_PROJECT=${PROJECT}
    ports:
      - 9200:9200
    volumes:
      - $HOME/.config/gcloud:/root/.config/gcloud
  redis:
    image: redis:alpine
    ports:
      - 6379:6379
    volumes:
      - redis_data:/data
  api:
    build:
      context: ..
      dockerfile: deploy/dockerfiles/browser/api.dockerfile
    command: node graphql-api/src/app.js
    environment:
      - NODE_ENV=development
      - PORT=8000
      - ELASTICSEARCH_URL=http://elasticsearch-proxy:9200
      - ELASTICSEARCH_USERNAME=elastic
      - ELASTICSEARCH_PASSWORD
      # Redis configuration (using legacy REDIS_HOST/PORT variables)
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      # CopilotKit PostgreSQL database
      - DATABASE_URL=postgresql://gnomad:gnomad_dev@postgres:5432/gnomad_copilot
      # CopilotKit AI
      - GOOGLE_GENERATIVE_AI_API_KEY
      # MCP server callback URL (inside container, API runs on port 8000)
      - GNOMAD_API_URL=http://127.0.0.1:8000/api
      # Use container path for gmd, not host path
      - GMD_COMMAND_PATH=gmd
    ports:
      - 8010:8000
    # Note: No volume mounts = using compiled code from image (no hot-reload)
    depends_on:
      - elasticsearch-proxy
      - redis
      - postgres
volumes:
  redis_data:
  postgres_data:
