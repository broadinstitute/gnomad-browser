name: Deploy
on:
  workflow_dispatch:
  push:
    branches:
      - ourdna-browser
      - ourdna-browser-dev

permissions:
  id-token: write
  contents: read

env:
  PROJECT_ID: ${{ secrets.GKE_PROJECT }}
  GKE_CLUSTER: ${{ secrets.GKE_CLUSTER }}
  GKE_ZONE: australia-southeast1-a
  DEPLOYMENT_NAME: ${{ secrets.GKE_PROJECT }}-green
  DOCKER_REGISTRY: australia-southeast1-docker.pkg.dev

jobs:
  setup-build-publish-deploy:
    name: Setup, Build, Publish, and Deploy
    runs-on: ubuntu-latest
    environment: ${{ github.ref_name == 'ourdna-browser' && 'production' || 'development' }}
    env:
      DOCKER_BUILDKIT: 1
      BUILDKIT_PROGRESS: plain
      CLOUDSDK_CORE_DISABLE_PROMPTS: 1
      API_DOCKER: gnomad/gnomad-api
      BROWSER_DOCKER: gnomad/gnomad-browser

    defaults:
      run:
        shell: bash -eo pipefail -l {0}
    steps:
      - uses: actions/checkout@v4

      - name: "Setup env vars based on short SHA"
        id: vars
        run: |
          calculatedSha=$(git rev-parse --short ${{ github.sha }})
          echo "COMMIT_SHORT_SHA=$calculatedSha" >> $GITHUB_ENV

          apiImageId=$DOCKER_REGISTRY/$PROJECT_ID/$API_DOCKER:$calculatedSha
          echo "API_DOCKER_ID=$apiImageId" >> $GITHUB_ENV

          webImageId=$DOCKER_REGISTRY/$PROJECT_ID/$BROWSER_DOCKER:$calculatedSha
          echo "BROWSER_DOCKER_ID=$webImageId" >> $GITHUB_ENV

      - name: "Confirm git commit SHA output"
        run: echo ${{ env.COMMIT_SHORT_SHA }}

      - id: "google-cloud-auth"
        name: "Authenticate to Google Cloud"
        uses: "google-github-actions/auth@v2"
        with:
          workload_identity_provider: "projects/${{ secrets.GKE_PROJECT_ID }}/locations/global/workloadIdentityPools/github-pool/providers/github-provider"
          service_account: "github-deploy@${{ secrets.GKE_PROJECT }}.iam.gserviceaccount.com"

      - id: "google-cloud-sdk-setup"
        name: "Set up Cloud SDK"
        uses: google-github-actions/setup-gcloud@v2
        with:
          install_components: "gke-gcloud-auth-plugin"

      - name: "Docker auth"
        run: |
          gcloud --quiet auth configure-docker $DOCKER_REGISTRY

      - name: "Build API image"
        run: |
          docker build \
            --pull --provenance=false \
            --tag ${{ env.API_DOCKER_ID }} \
            -f deploy/dockerfiles/browser/api.dockerfile \
            .

      - name: "Build Browser image"
        run: |
          echo 'GNOMAD_API_URL="${{ secrets.GNOMAD_API_URL }}"' > browser/build.env
          docker build \
            --pull --provenance=false \
            --tag ${{ env.BROWSER_DOCKER_ID }} \
            -f deploy/dockerfiles/browser/browser.dockerfile \
            .

      # Push the Docker image to Google Artifact Registry
      - name: "Publish to Artifact Registry"
        run: |-
          docker push ${{ env.API_DOCKER_ID }}
          docker push ${{ env.BROWSER_DOCKER_ID }}

      # Configure kubectl
      - name: "Authenticate kubectl"
        run: |-
          gcloud container clusters get-credentials $GKE_CLUSTER --region=$GKE_ZONE

      # Deploy the Docker image to the GKE cluster
      - name: Deploy API
        run: |-
          kubectl set image deployment/gnomad-api-$DEPLOYMENT_NAME app=${{ env.API_DOCKER_ID }}
          kubectl rollout status deployment/gnomad-api-$DEPLOYMENT_NAME

      # Deploy the Docker image to the GKE cluster
      - name: Deploy Web
        run: |-
          kubectl set image deployment/gnomad-browser-$DEPLOYMENT_NAME web=${{ env.BROWSER_DOCKER_ID }}
          kubectl rollout status deployment/gnomad-browser-$DEPLOYMENT_NAME
